generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
// --- ENUMS ---

enum AuthProvider {
  local
  google
}

enum PropertyType {
  apartment
  house
  maisonette
  bungalow
  other
}

enum PropertyStatus {
  saved
  interested
  viewed
  applied
  rejected
}

// --- MODELS ---

model User {
  id              String         @id @default(uuid())
  email           String         @unique @db.VarChar(255)
  password_hash   String?        @db.VarChar(128)
  name            String?        @db.VarChar(100)
  google_id       String?        @unique 
  profile_picture String?
  auth_provider   AuthProvider   @default(local)
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt

  // Relationships
  properties    Property[]
  viewings      Viewing[]
  comparisons   Comparison[]
  tags          Tag[]
}

model Property {
  id              String           @id @default(uuid())
  user_id         String
  title           String           @db.VarChar(200)
  address         String           @db.VarChar(255) // e.g., Estate Name, Street Address
  city            String           @db.VarChar(100) // e.g., Nairobi, Mombasa (Major city/town)
  county          String           @db.VarChar(100)
  zip_code        String?          @db.VarChar(20)  // Optional postal code
  price           Decimal          @db.Decimal(12, 2) // KES
  bedrooms        Int
  bathrooms       Float 
  square_feet     Int?
  property_type   PropertyType
  listing_url     String?
  image_urls      String[]
  status          PropertyStatus   @default(saved)
  notes           String?          @db.Text
  pros            String[]
  cons            String[]
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  // Relationships
  user            User             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  viewings        Viewing[]
  propertyTags    PropertyTag[] 

  // Indexes (updated for county)
  @@index([user_id])
  @@index([status])
  @@index([city])
  @@index([county])
  @@index([price])
}

model Viewing {
  id                String    @id @default(uuid())
  property_id       String
  user_id           String 
  scheduled_date    DateTime  
  scheduled_time    DateTime? 
  duration_minutes  Int       @default(30)
  location_notes    String?   @db.Text
  attended          Boolean   @default(false)
  viewing_notes     String?   @db.Text
  rating            Int?      @db.SmallInt // 1-10

  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  // Relationships
  property          Property  @relation(fields: [property_id], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Indexes
  @@index([property_id])
  @@index([user_id])
  @@index([scheduled_date])
}

model Comparison {
  id              String    @id @default(uuid())
  user_id         String
  name            String    @db.VarChar(100)
  property_ids    String[]  // Array of Property UUIDs
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  // Relationships
  user            User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Indexes
  @@index([user_id])
}

model Tag {
  id              String          @id @default(uuid())
  user_id         String
  name            String          @db.VarChar(50)
  color           String?         @db.VarChar(7) 
  created_at      DateTime        @default(now())

  // Relationships
  user            User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  propertyTags    PropertyTag[]

  // Constraint: unique tag name per user
  @@unique([user_id, name])
  @@index([user_id])
}

model PropertyTag {
  property_id     String
  tag_id          String
  created_at      DateTime        @default(now())

  // Relationships
  property        Property        @relation(fields: [property_id], references: [id], onDelete: Cascade)
  tag             Tag             @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  // Composite key for the join table
  @@id([property_id, tag_id])
}