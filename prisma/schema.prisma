// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum AuthProvider {
  local
  google
}

enum PropertyType {
  apartment
  house
  maisonette
  bungalow
  other
}

enum PropertyStatus {
  saved
  interested
  viewed
  applied
  rejected
}

// --- MODELS ---

model User {
  id              String         @id @default(uuid())
  email           String         @unique @db.VarChar(255)
  password_hash   String?        @db.VarChar(128)
  name            String?        @db.VarChar(100)
  google_id       String?        @unique 
  profile_picture String?
  auth_provider   AuthProvider   @default(local)
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt

  // Relationships (Explicit naming added for all)
  listings        Listing[]       @relation("PostedListings")     
  savedProperties SavedProperty[] @relation("SavedProperties")
  viewings        Viewing[]       @relation("ScheduledViewings")   
  comparisons     Comparison[]    @relation("UserComparisons")    
  tags            Tag[]           @relation("UserTags")            
}


model Listing {
  id              String           @id @default(uuid())
  user_id         String           
  title           String           @db.VarChar(200)
  address         String           @db.VarChar(255) 
  city            String           @db.VarChar(100) 
  county          String           @db.VarChar(100) 
  zip_code        String?          @db.VarChar(20)  
  price           Decimal          @db.Decimal(12, 2) 
  bedrooms        Int
  bathrooms       Float 
  square_feet     Int?
  property_type   PropertyType
  listing_url     String?          
  image_urls      String[]         
  is_active       Boolean          @default(true)
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  // Relationships
  lister          User             @relation("PostedListings", fields: [user_id], references: [id], onDelete: Cascade) // 1. Listing side
  savedProperties SavedProperty[]  @relation("SavedListingCopies")
  viewings        Viewing[]        @relation("ListingViewings")
  
  @@index([user_id])
  @@index([city])
  @@index([county])
  @@index([price])
}



model SavedProperty {
  id              String           @id @default(uuid())
  user_id         String           
  listing_id      String           
  

  status          PropertyStatus   @default(saved)
  notes           String?          @db.Text
  pros            String[]
  cons            String[]
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  // Relationships
  hunter          User             @relation("SavedProperties", fields: [user_id], references: [id], onDelete: Cascade) 
  listing         Listing          @relation("SavedListingCopies", fields: [listing_id], references: [id], onDelete: Cascade)
  viewings        Viewing[]        @relation("SavedPropertyViewings")
  tags            SavedPropertyTag[] @relation("SavedPropertyTags")
  
  // Indexes 
  @@index([user_id])
  @@index([listing_id])
  @@index([status])

  @@unique([user_id, listing_id], name: "saved_property_pk") 
}


model Viewing {
  id                String    @id @default(uuid())
  user_id           String    
  listing_id        String    
  
  scheduled_date    DateTime  
  scheduled_time    DateTime? 
  duration_minutes  Int       @default(30)
  location_notes    String?   @db.Text
  attended          Boolean   @default(false)
  viewing_notes     String?   @db.Text
  rating            Int?      @db.SmallInt // 1-10

  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  // Relationships
  hunter            User           @relation("ScheduledViewings", fields: [user_id], references: [id], onDelete: Cascade)
  listing           Listing        @relation("ListingViewings", fields: [listing_id], references: [id], onDelete: Cascade)
  saved_property_id String?
  savedProperty     SavedProperty? @relation("SavedPropertyViewings", fields: [saved_property_id], references: [id], onDelete: SetNull)

  // Indexes 
  @@index([listing_id])
  @@index([user_id])
  @@index([scheduled_date])
}


model Comparison {
  id              String    @id @default(uuid())
  user_id         String
  name            String    @db.VarChar(100)
  listing_ids     String[]  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  // Relationships
  user            User      @relation("UserComparisons", fields: [user_id], references: [id], onDelete: Cascade) 

  // Indexes 
  @@index([user_id])
}


model Tag {
  id              String          @id @default(uuid())
  user_id         String          
  name            String          @db.VarChar(50)
  color           String?         @db.VarChar(7) 
  created_at      DateTime        @default(now())

  // Relationships
  user            User            @relation("UserTags", fields: [user_id], references: [id], onDelete: Cascade) // 5. Tag side
  savedPropertyTags SavedPropertyTag[] 

  // Constraint: unique tag name per user
  @@unique([user_id, name])
  @@index([user_id])
}

model SavedPropertyTag { 
  saved_property_id String 
  tag_id          String
  created_at      DateTime        @default(now())

  // Relationships
  savedProperty   SavedProperty   @relation("SavedPropertyTags", fields: [saved_property_id], references: [id], onDelete: Cascade) // Fix 6: SavedPropertyTag side
  tag             Tag             @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  // Composite key for the join table
  @@id([saved_property_id, tag_id]) 
}